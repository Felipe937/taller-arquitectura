name: EventFlow CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt
        pip install pytest coverage
        
    - name: Run tests with coverage
      run: |
        cd src
        coverage run --source=. -m pytest tests/ -v --junitxml=test-results.xml
        coverage xml -i
        
    - name: Fix coverage file paths
      run: |
        sed -i 's/filename="/filename="src\//g' src/coverage.xml
        
    - name: Clean SonarCloud cache
      run: |
        echo "Forcing clean analysis with new project key"
        
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=SpaceYisus_taller_arquitectura_CLEAN
          -Dsonar.organization=spaceyisus
          -Dsonar.python.coverage.reportPaths=src/coverage.xml
          -Dsonar.python.xunit.reportPath=src/test-results.xml
          -Dsonar.sources=src
          -Dsonar.tests=src/tests
